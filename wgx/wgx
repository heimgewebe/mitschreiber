#!/usr/bin/env bash
set -euo pipefail

# wgx – profilgetriebener Task-Runner für dieses Repo.
# Liest .wgx/profile.yml, extrahiert tasks.<name> und führt
# das hinterlegte Shell-Snippet aus.

WGX_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
PROFILE="${WGX_ROOT}/.wgx/profile.yml"

if [[ ! -f "${PROFILE}" ]]; then
  echo "[wgx] ::error::.wgx/profile.yml fehlt (erwartet unter ${PROFILE})" >&2
  exit 1
fi

# YAML-Parser laden
if [[ ! -f "${WGX_ROOT}/wgx/lib/parse_yaml.sh" ]]; then
  echo "[wgx] ::error::wgx/lib/parse_yaml.sh fehlt" >&2
  exit 1
fi
source "${WGX_ROOT}/wgx/lib/parse_yaml.sh"

SUBCOMMAND="${1:-}"

if [[ -z "${SUBCOMMAND}" ]]; then
  cat >&2 <<EOF
Usage: wgx <task>

Bekannte Tasks werden aus .wgx/profile.yml (tasks.<name>) gelesen,
zum Beispiel:

  wgx smoke
  wgx guard
  wgx metrics
  wgx snapshot

EOF
  echo "Hinweis: Profil liegt in .wgx/profile.yml, nur einfache 'tasks.<name> = einzeiliger Befehl' werden unterstützt." >&2
  exit 1
fi

# Profil in Umgebungsvariablen expandieren
eval "$(parse_yaml "${PROFILE}" "wgx_")"

TASK_VAR="wgx_tasks_${SUBCOMMAND}"
TASK_COMMAND="${!TASK_VAR:-}"

if [[ -z "${TASK_COMMAND}" ]]; then
  echo "[wgx] Hinweis: kein Task '${SUBCOMMAND}' im Profil definiert" >&2
  echo "[wgx] Bekannte Tasks (Auszug):" >&2
  env | grep '^wgx_tasks_' || true
  exit 1
fi

echo "[wgx] running task '${SUBCOMMAND}'..."

# Zur Sicherheit in Repo-Root wechseln
cd "${WGX_ROOT}"

# Sanitize TASK_COMMAND:
# 1. Strip leading YAML block marker line (a line that is only '|' possibly surrounded by whitespace)
# 2. Remove leading blank lines
# 3. Validate that command is non-empty after sanitization
# 4. Guard against commands that still begin with '|'

# Strip a leading line that is only '|' (with optional surrounding whitespace)
TASK_COMMAND="$(printf '%s' "${TASK_COMMAND}" | sed '1{/^[[:space:]]*|[[:space:]]*$/d}')"

# Remove leading blank lines
TASK_COMMAND="$(printf '%s' "${TASK_COMMAND}" | sed '/./,$!d')"

# Validate that the command is non-empty after sanitization
if [[ -z "${TASK_COMMAND}" ]] || [[ "${TASK_COMMAND}" =~ ^[[:space:]]*$ ]]; then
  echo "[wgx] ::error::task '${SUBCOMMAND}' has empty command after sanitization" >&2
  exit 1
fi

# Guard against commands that still begin with '|' (which would cause bash syntax error)
if [[ "${TASK_COMMAND}" =~ ^[[:space:]]*\| ]]; then
  echo "[wgx] ::error::task '${SUBCOMMAND}' command starts with '|' which is invalid for bash" >&2
  exit 1
fi

# Befehl in einer neuen Shell ausführen, damit lokale set-Optionen etc.
# im Profil-Kommando keinen Einfluss auf diesen Wrapper haben.
# Use "--" separator to avoid accidental interpretation of command strings as options.
bash -lc -- "${TASK_COMMAND}"

status=$?
if [[ $status -ne 0 ]]; then
  echo "[wgx] task '${SUBCOMMAND}' failed with status ${status}" >&2
  exit "$status"
fi

echo "[wgx] task '${SUBCOMMAND}' finished successfully."
